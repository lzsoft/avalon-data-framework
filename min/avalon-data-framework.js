{const e="data-url",t="data-json",n="data-auto-get",a="data-get-after-put",i="data-loop",l="data-loop-delete",r="data-penetrate",s="data-analyzing",c="data-loading",o="tingting-adf",d="element-summary",u="template-map",f="entity-list",p="loop-util",h="GET",b="PUT",A="IDENTIFIER",g="STRING",E="JSON",m="INTEGER",w="FLOAT",v="BOOLEAN",k="DATE",y="TIME",T="PARAM",N="VAL",O="SEGMENT",L="{{",S="}}",M="[[",x="]]",C="(",D=")",P=":",I="GET",z="PUT",R="GETDONE",G="PUTDONE";window.customElements.define("avalon-data-framework",class extends HTMLElement{validate(){return!0}analyze(e){function t(t){function r(t,i,l){let r=l,s=!1,f=[];for(;c(r);){s=!0;let i=n(r),c=a(i),u=c.shift(),p="";for(let e of c)switch(!0){case e.includes(T):p=window.location.getParam(e.replace(T,"").replace(C,"").replace(D,""));break;case e.includes(N):p=e.replace(N,"").replace(C,"").replace(D,"")||0;break;case e.includes(O):p=window.location.getPathLastSegment()}c.includes(A)&&e[o][d][A].add(t),c.includes(h)&&e[o][d][h].add(t),c.includes(b)&&e[o][d][b].add(t),f.push({path:u,template:p||i,keywords:c}),p?(r=r.replace(i,p),l=l.replace(i,p)):r=r.replace(i,"")}s&&(i?t.setAttribute(i,r):t.textContent=r,t[o][u].set(i,{template:l,fields:f}))}t.setAttribute(s,""),t[o]=t[o]||{},t[o][u]=t[o][u]||new Map,t instanceof HTMLTemplateElement&&t.hasAttribute(i)&&(t[o][f]=[],t[o][p]={},t[o][p].deleteMap=new Map,t[o][p].appendNewEntity=function(e){let n=document.createElement("div");n.innerHTML=t.innerHTML,g.analyze(n),g.render(n,e);let a=[];for(;n.firstChild;)a.push(n.firstChild),t.parentNode.appendChild(n.firstChild);for(let e of n.querySelectorAll("["+l+"]"))t[o][p].deleteMap.set(e,a),e.addEventListener("click",function(){t[o][p].deleteAllEntity(e,!0)});t[o][f].push(n[o][d])},t[o][p].deleteAllEntity=function(e){let n=t[o][p].deleteMap.get(e);for(let e of n)e.remove()}),0===t.children.length&&r(t,"",t.textContent);let E=0,m=Array.from(t.attributes);for(;E<m.length;)r(t,m[E].name,m[E].value),function(e,t,n){if(n.includes(M)&&n.includes(x)&&n.indexOf(M)<n.indexOf(x)&&0===n.indexOf(M)){let a=t.substring(2),i=n.replace(M,"").replace(x,"").split(P);for(let t of i)e.addEventListener(a,function(){g.dispatchEvent(new Event(t))});return e.removeAttribute(t),!0}}(t,m[E].name,m[E].value),E++;t.removeAttribute(s)}function n(e){return e.substring(e.indexOf(L),e.indexOf(S)+2)}function a(e){return e.replace(L,"").replace(S,"").split(P)}function c(e){return e.includes(L)&&e.includes(S)&&e.indexOf(L)<e.indexOf(S)}let g=this;e[o]=e[o]||{},e[o][d]={[h]:new Set,[b]:new Set,[A]:new Set};let E=e.querySelectorAll("*");for(let e of E)if(!e.hasAttribute(s)){let n=e.parentNode,a=1+(e.hasAttribute(r)?parseInt(e.getAttribute(r),10):0);for(;n&&a>0;)"AVALON-DATA-FRAMEWORK"===n.tagName&&0===--a&&n===g&&t(e),n=n.parentNode;a>0&&t(e)}}eventize(){let n=this;n.addEventListener(I,async function(a){function i(e){n.render(n,e,!1),n.removeAttribute(c),n.dispatchEvent(new CustomEvent(R,{detail:e}))}if(a.stopPropagation(),!n.hasAttribute(c))try{n.setAttribute(c,"");let l=n.gather(n,!0);i(n.hasAttribute(e)?await window.tingting.api.get(n.getAttribute(e),l):n.hasAttribute(t)?JSON.parse(n.getAttribute(t)):null)}catch(a){n.removeAttribute(c)}}),n.addEventListener(z,async function(i){function l(e){n.removeAttribute(c),n.hasAttribute(a)?n.dispatchEvent(new Event(I)):n.render(n,e,!1),n.dispatchEvent(new CustomEvent(G,{detail:e}))}if(i.stopPropagation(),!n.hasAttribute(c))try{n.setAttribute(c,"");let a=n.gather(n,!1);n.hasAttribute(e)?l(await window.tingting.api.put(n.getAttribute(e),a)):n.hasAttribute(t)?(n.setAttribute(t,JSON.stringify(a)),l(a)):l(null)}catch(i){n.removeAttribute(c)}})}render(e,t){function n(e,t){if(1===(t=t.split("/")).length&&""===t[0]);else for(let n=0;n<t.length;n++)e=e?e[t[n]]:e;return e}let a=e[o][d][h];for(let e of a){let a=e[o][u];if("TEMPLATE"===e.tagName&&a.has(i))!function(e,a){if(a.fields[0].keywords.includes(h)){let i=a.fields[0].path,l=n(t,i)||[];for(let t of e[o][f])for(let e of t[h])e.remove();e[o][f]=[];for(let t of l)e[o][p].appendNewEntity(t)}}(e,a.get(i));else for(let i of a.keys())!function(e,a,i){let l=i.template,r=!1;for(let e of i.fields){let a=e.keywords;if(a.includes(h)){r=!0;let i=e.template,s=e.path,c=n(t,s);switch(!0){case a.includes(E):try{c=JSON.stringify(c)}catch(e){c=""}break;case a.includes(g):c=c.toString();break;case a.includes(m):case a.includes(w):c=c||0;break;case a.includes(v):break;case a.includes(k):c=new Date(c).toLocaleDateString();break;case a.includes(y):c=new Date(c).toLocaleTimeString()}l=l.replace(i,c||"")}}if(r)switch(a){case"":e.textContent=l;break;case"value":e.value=l;break;case"checked":l?e.setAttribute("checked",""):e.removeAttribute("checked");break;default:l||0===l?e.setAttribute(a,l):e.removeAttribute(a)}}(e,i,a.get(i))}}gather(e,t){function n(e,t,a){if("string"==typeof t&&(t=t.split("/")),t.length>1){let i=t.shift();null!==e[i]&&"object"==typeof e[i]||(e[i]={}),n(e[i],t,a)}else e[t[0]]=a}let a=this,l={},r=t?e[o][d][A]:e[o][d][b];for(let e of r){let r=e[o][u];if("TEMPLATE"===e.tagName&&r.has(i))!function(e,i){if(i.fields[0].keywords.includes(t?A:b)){let r=i.fields[0].path,s=[],c=e[o][f];for(let e of c){let n=document.createElement("div");for(let t of e[b])if(t.getRootNode()===t.ownerDocument){let e=t.cloneNode(!0);n.appendChild(e)}else e[b].delete(t);e[b].size>0&&(n[o]={},n[o][d]=e,s.push(a.gather(n,t)))}n(l,r,s)}}(e,r.get(i));else for(let a of r.keys())!function(e,a,i){let r=i.fields[0].keywords;if(r.includes(t?A:b)){let t=i.fields[0].path,s=null;switch(a){case"":s=e.textContent;break;case"value":s=e.value;break;case"checked":s=e.checked;break;default:s=e.getAttribute(a)}switch(!0){case r.includes(E):try{s=JSON.parse(s)}catch(e){s=null}break;case r.includes(g):s=s.toString();break;case r.includes(m):s=parseInt(s,10)||0;break;case r.includes(w):s=parseFloat(s)||0;break;case r.includes(v):s="true"===s;break;case r.includes(k):case r.includes(y):s=new Date(s)}n(l,t,s)}}(e,a,r.get(a))}return l}constructor(){super()}connectedCallback(){this.validate(),this.analyze(this),this.eventize(),this.hasAttribute(n)&&this.dispatchEvent(new Event(I))}})}