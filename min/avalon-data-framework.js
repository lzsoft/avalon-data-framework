{const e="data-get-after-put",t="data-loop",a="data-loop-delete",n="data-analyzing",i="data-loading",l="avalon-adf",r="element-summary",s="template-map",c="entity-list",o="loop-util",d="GET",u="PUT",f="IDENTIFIER",p="STRING",h="JSON",b="INTEGER",A="FLOAT",g="BOOLEAN",E="DATE",m="TIME",v="PARAM",w="VAL",k="SEGMENT",y="{{",T="}}",N="[[",O="]]",L="(",S=")",M=":",x="GET",C="GETDONE",D="PUTDONE";window.customElements.define("avalon-data-framework",class extends HTMLElement{validate(){return!0}analyze(e){function i(i){function h(t,a,n){let i=n,c=!1,o=[];for(;function(e){return e.includes(y)&&e.includes(T)&&e.indexOf(y)<e.indexOf(T)}(i);){c=!0;let a=function(e){return e.substring(e.indexOf(y),e.indexOf(T)+2)}(i),s=function(e){return e.replace(y,"").replace(T,"").split(M)}(a),p=s.shift(),h="";for(let e of s)switch(!0){case e.includes(v):h=window.location.getParam(e.replace(v,"").replace(L,"").replace(S,""));break;case e.includes(w):h=e.replace(w,"").replace(L,"").replace(S,"")||0;break;case e.includes(k):h=window.location.getPathLastSegment()}s.includes(f)&&e[l][r][f].add(t),s.includes(d)&&e[l][r][d].add(t),s.includes(u)&&e[l][r][u].add(t),o.push({path:p,template:h||a,keywords:s}),h?(i=i.replace(a,h),n=n.replace(a,h)):i=i.replace(a,"")}c&&(a?t.setAttribute(a,i):t.textContent=i,t[l][s].set(a,{template:n,fields:o}))}i.setAttribute(n,""),i[l]=i[l]||{},i[l][s]=i[l][s]||new Map,i instanceof HTMLTemplateElement&&i.hasAttribute(t)&&(i[l][c]=[],i[l][o]={},i[l][o].deleteMap=new Map,i[l][o].appendNewEntity=function(e){let t=document.createElement("div");t.innerHTML=i.innerHTML,p.analyze(t),p.render(t,e);let n=[];for(;t.firstChild;)n.push(t.firstChild),i.parentNode.appendChild(t.firstChild);for(let e of t.querySelectorAll("["+a+"]"))i[l][o].deleteMap.set(e,n),e.addEventListener("click",function(){i[l][o].deleteAllEntity(e,!0)});i[l][c].push(t[l][r])},i[l][o].deleteAllEntity=function(e){let t=i[l][o].deleteMap.get(e);for(let e of t)e.remove()}),0===i.children.length&&h(i,"",i.textContent);let b=0,A=Array.from(i.attributes);for(;b<A.length;)h(i,A[b].name,A[b].value),function(e,t,a){if(a.includes(N)&&a.includes(O)&&a.indexOf(N)<a.indexOf(O)&&0===a.indexOf(N)){let n=t.substring(2),i=a.replace(N,"").replace(O,"").split(M);for(let t of i)e.addEventListener(n,function(){p.dispatchEvent(new Event(t))});return e.removeAttribute(t),!0}}(i,A[b].name,A[b].value),b++;i.removeAttribute(n)}let p=this;e[l]=e[l]||{},e[l][r]={[d]:new Set,[u]:new Set,[f]:new Set};let h=e.querySelectorAll("*");for(let e of h)if(!e.hasAttribute(n)){let t=e.parentNode,a=1+(e.hasAttribute("data-penetrate")?parseInt(e.getAttribute("data-penetrate"),10):0);for(;t&&a>0;)"AVALON-DATA-FRAMEWORK"===t.tagName&&0===--a&&t===p&&i(e),t=t.parentNode;a>0&&i(e)}}eventize(){let t=this;t.addEventListener(x,async function(e){function a(e){t.render(t,e,!1),t.removeAttribute(i),t.dispatchEvent(new CustomEvent(C,{detail:e}))}if(e.stopPropagation(),!t.hasAttribute(i))try{t.setAttribute(i,"");let n=t.gather(t,!0);a(t.hasAttribute("data-url")?await window.avalon.api.get(t.getAttribute("data-url"),n):t.hasAttribute("data-json")?JSON.parse(t.getAttribute("data-json")):null)}catch(e){t.removeAttribute(i)}}),t.addEventListener("PUT",async function(a){function n(a){t.removeAttribute(i),t.hasAttribute(e)?t.dispatchEvent(new Event(x)):t.render(t,a,!1),t.dispatchEvent(new CustomEvent(D,{detail:a}))}if(a.stopPropagation(),!t.hasAttribute(i))try{t.setAttribute(i,"");let e=t.gather(t,!1);t.hasAttribute("data-url")?n(await window.avalon.api.put(t.getAttribute("data-url"),e)):t.hasAttribute("data-json")?(t.setAttribute("data-json",JSON.stringify(e)),n(e)):n(null)}catch(a){t.removeAttribute(i)}})}render(e,a){function n(e,t){if(1===(t=t.split("/")).length&&""===t[0]);else for(let a=0;a<t.length;a++)e=e?e[t[a]]:e;return e}let i=e[l][r][d];for(let e of i){let i=e[l][s];if("TEMPLATE"===e.tagName&&i.has(t))!function(e,t){if(t.fields[0].keywords.includes(d)){let i=t.fields[0].path,r=n(a,i)||[];for(let t of e[l][c])for(let e of t[d])e.remove();e[l][c]=[];for(let t of r)e[l][o].appendNewEntity(t)}}(e,i.get(t));else for(let t of i.keys())!function(e,t,i){let l=i.template,r=!1;for(let e of i.fields){let t=e.keywords;if(t.includes(d)){r=!0;let i=e.template,s=e.path,c=n(a,s);if(c){switch(!0){case t.includes(h):try{c=JSON.stringify(c)}catch(e){c=""}break;case t.includes(p):c=c.toString();break;case t.includes(b):case t.includes(A):c=c||0;break;case t.includes(g):break;case t.includes(E):c=new Date(c).toLocaleDateString();break;case t.includes(m):c=new Date(c).toLocaleTimeString()}l=l.replace(i,c)}else l=l.replace(i,"")}}if(r)switch(t){case"":e.textContent=l;break;case"value":e.value=l;break;case"checked":l?e.setAttribute("checked",""):e.removeAttribute("checked");break;default:l||0===l?e.setAttribute(t,l):e.removeAttribute(t)}}(e,t,i.get(t))}}gather(e,a){function n(e,t,a){if("string"==typeof t&&(t=t.split("/")),t.length>1){let i=t.shift();null!==e[i]&&"object"==typeof e[i]||(e[i]={}),n(e[i],t,a)}else e[t[0]]=a}let i=this,o={},d=a?e[l][r][f]:e[l][r][u];for(let e of d){let d=e[l][s];if("TEMPLATE"===e.tagName&&d.has(t))!function(e,t){if(t.fields[0].keywords.includes(a?f:u)){let s=t.fields[0].path,d=[],f=e[l][c];for(let e of f){let t=document.createElement("div");for(let a of e[u])if(a.getRootNode()===a.ownerDocument){let e=a.cloneNode(!0);t.appendChild(e)}else e[u].delete(a);e[u].size>0&&(t[l]={},t[l][r]=e,d.push(i.gather(t,a)))}n(o,s,d)}}(e,d.get(t));else for(let t of d.keys())!function(e,t,i){let l=i.fields[0].keywords;if(l.includes(a?f:u)){let a=i.fields[0].path,r=null;switch(t){case"":r=e.textContent;break;case"value":r=e.value;break;case"checked":r=e.checked;break;default:r=e.getAttribute(t)}switch(!0){case l.includes(h):try{r=JSON.parse(r)}catch(e){r=null}break;case l.includes(p):r=r.toString();break;case l.includes(b):r=parseInt(r,10)||0;break;case l.includes(A):r=parseFloat(r)||0;break;case l.includes(g):r="true"===r;break;case l.includes(E):case l.includes(m):r=new Date(r)}n(o,a,r)}}(e,t,d.get(t))}return o}constructor(){super()}connectedCallback(){this.validate(),this.analyze(this),this.eventize(),this.hasAttribute("data-auto-get")&&this.dispatchEvent(new Event(x))}})}